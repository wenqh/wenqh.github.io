<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“º å½“å‰èŠ‚ç›®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 1em; }
        .source-links a {
            margin-right: 1em;
            padding: 0.4em 0.8em;
            text-decoration: none;
            color: #007bff;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        .source-links a.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .channel { margin-bottom: 1em; }
        .channel-name { font-weight: bold; }
        .next-program { margin-top: 20px; font-size: 18px; color: green; }
    </style>
</head>
<body>
    <h1>æ­£åœ¨æ’­æ”¾çš„èŠ‚ç›®</h1>
    <div class="source-links" id="source-links">
        <a href="https://raw.githubusercontent.com/linitfor/epg/refs/heads/main/merged.xml" class="active">é»˜è®¤æº</a>
        <a href="https://raw.githubusercontent.com/yangguanll/iptv-api/refs/heads/master/output/epg/epg.xml">å¤‡ç”¨æº</a>
        <a href="https://raw.githubusercontent.com/dujq666/tv/refs/heads/master/output/epg/epg.xml">å¤‡ç”¨æº</a>
    </div>
    <div id="content">åŠ è½½ä¸­...</div>
    <div id="next-program" class="next-program"></div>

    <script>
        const sourceLinks = document.getElementById('source-links');
        const content = document.getElementById('content');
        const nextProgramElement = document.getElementById('next-program');

        function loadEPG(url) {
            fetch(url)
                .then(response => response.text())
                .then(txt => {
                    const doc = new DOMParser().parseFromString(txt, "application/xml");
                    const now = new Date().toISOString().slice(0, 14);

                    const channels = {};
                    Array.from(doc.getElementsByTagName('channel')).forEach(channel => {
                        const id = channel.getAttribute('id');
                        channels[id] = channel.querySelector('display-name')?.textContent || id;
                    });

                    const currentPrograms = [];
                    const nextPrograms = [];
                    Array.from(doc.getElementsByTagName('programme')).forEach(programme => {
                        const start = programme.getAttribute('start');
                        const stop = programme.getAttribute('stop');
                        const channelId = programme.getAttribute('channel');

                        if (now >= start && now < stop) {
                            currentPrograms.push({ channel: channels[channelId], title: programme.querySelector('title')?.textContent });
                        } else if (now < start) {
                            nextPrograms.push({
                                channel: channels[channelId], title: programme.querySelector('title')?.textContent, startTime: start
                            });
                        }
                    });

                    content.innerHTML = currentPrograms.length ? currentPrograms.map(p => 
                        `<div class="channel"><div class="channel-name">${p.channel}</div><div>${p.title}</div></div>`
                    ).join('') : 'å½“å‰æ— æ­£åœ¨æ’­æ”¾çš„èŠ‚ç›®ã€‚';

                    if (nextPrograms.length) {
                        const nextProgram = nextPrograms[0];
                        const timeRemaining = Math.floor((new Date(nextProgram.startTime) - new Date()) / 60000);
                        nextProgramElement.innerHTML = `
                            <strong>ä¸‹ä¸€ä¸ªèŠ‚ç›®ï¼š</strong><br>
                            ${nextProgram.channel} - ${nextProgram.title}<br>
                            å¼€å§‹æ—¶é—´ï¼š${new Date(nextProgram.startTime).toLocaleTimeString()}<br>
                            è¿˜å‰© ${timeRemaining} åˆ†é’Ÿ
                        `;
                    }
                })
                .catch(err => {
                    content.textContent = 'åŠ è½½å¤±è´¥ï¼š' + err;
                    console.error(err);
                });
        }

        loadEPG(sourceLinks.querySelector('a').href);

        sourceLinks.addEventListener('click', e => {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                sourceLinks.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                e.target.classList.add('active');
                loadEPG(e.target.href);
            }
        });
    </script>
</body>
</html>
