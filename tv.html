<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ðŸ“º</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Materialize CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>
        body {
            font-weight: bold;
        }
        a {
            color: black !important;
        }
    </style>
</head>
<body>
<!-- ç”¨æˆ·è¾“å…¥ TvBox URL -->
<div class="container" style="padding-top: 20px;">
    <!-- Modal Trigger -->
    <a class="btn btn-flat modal-trigger" href="#modal1">è®¾ç½®URL</a>

    <!-- Modal Structure -->
    <div id="modal1" class="modal">
        <div class="modal-content">
            <h4>TVBox URL</h4>
            <input id="tvbox-url" type="text" value="http://192.168.1.6:9978" placeholder="URL" class="validate">
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn-flat" id="saveTvBoxBtn">ç¡®å®š</a>
        </div>
    </div>
</div>

<div class="container">
    <h5 class="center-align">ç›´æ’­åˆ—è¡¨</h5>
    <div class="row">
        <div class="col s12">
            <ul class="tabs" id="tabHeader"></ul>
        </div>
        <div id="tabContent" class="col s12"><div>åŠ è½½ä¸­</div></div>
    </div>
</div>

<!-- Materialize JS -->
<script src="https://cdn.bootcdn.net/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    const SOURCE_URL = '/tv.txt'; // æœ¬åœ°æ–‡ä»¶è·¯å¾„

    // å¼‚æ­¥åŠ è½½æ–‡æœ¬å†…å®¹
    const fetchText = async (url) => {
        const res = await fetch(url);
        if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
        return res.text();
    };

    // è§£æžç›´æ’­æºæ ¼å¼
    const parseSource = (text) => {
        const lines = text.trim().split(/\r?\n/);
        const result = [];
        let currentCategory = null;

        for (const line of lines) {
            if (line.endsWith(',#genre#')) {
                const title = line.split(',')[0].trim();
                currentCategory = { title, items: [] };
                result.push(currentCategory);
            } else if (currentCategory && line.includes(',')) {
                const [name, url] = line.split(',');
                currentCategory.items.push({ name: name.trim(), url: url.trim() });
            }
        }

        return result;
    };

    // æ¸²æŸ“åˆ†ç±»å’Œé¢‘é“é¡¹
    const render = (data) => {
        const tabHeader = document.getElementById('tabHeader');
        const tabContent = document.getElementById('tabContent');
        tabHeader.innerHTML = '';
        tabContent.innerHTML = '';

        data.forEach((cat, i) => {
            const id = `tab-${i}`;
            tabHeader.innerHTML += `
          <li class="tab col s3">
            <a href="#${id}" class="${i === 0 ? 'active' : ''}">${cat.title}</a>
          </li>
        `;

            const listItems = cat.items.map(({ name, url }) =>
                `<li class="collection-item">
            <a href="javascript:void(0);" onclick="submitForm('${url}')">
              ${name}<div class="grey-text text-darken-1" style="font-size: 12px; margin-top: 4px;">${url}</div>
            </a>
          </li>`
            ).join('');

            tabContent.innerHTML += `
          <div id="${id}" class="col s12">
            <ul class="collection">${listItems}</ul>
          </div>
        `;
        });

        M.Tabs.init(tabHeader);
    };

    // æäº¤é¢‘é“åœ°å€åˆ°ç›®æ ‡æŽ¥å£
    const submitForm = (channelUrl) => {
        const tvboxUrl = localStorage.getItem('tvbox-url'); // ä»Ž localStorage èŽ·å– tvbox-url
        if (!tvboxUrl) {
            alert('è¯·å…ˆè®¾ç½® TvBox URL');
            return;
        }

        const formUrl = `${tvboxUrl}?do=push&url=${encodeURIComponent(channelUrl)}`;

        // åœ¨æ–°çš„æ ‡ç­¾é¡µæ‰“å¼€è¯¥é“¾æŽ¥
        window.open(formUrl, '_blank');
    };

    // é¡µé¢åŠ è½½åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
        M.Modal.init(document.querySelectorAll('.modal'));

        try {
            const raw = await fetchText(SOURCE_URL);
            const parsed = parseSource(raw);
            render(parsed);
        } catch (err) {
            alert('ç›´æ’­æºåŠ è½½å¤±è´¥ï¼š' + err.message);
        }


        const tvboxInput = document.getElementById('tvbox-url');
        const savedUrl = localStorage.getItem('tvbox-url');
        tvboxInput.value = savedUrl || 'http://192.168.1.6:9978'; // é»˜è®¤ URL

        // ä¿å­˜ç”¨æˆ·è¾“å…¥çš„ URL åˆ° localStorage
        saveTvBoxBtn.addEventListener('click', (e) => {
            const url = tvboxInput.value.trim();
            if (url) {
                localStorage.setItem('tvbox-url', url);
            }
        });

    });
</script>
</body>
</html>
