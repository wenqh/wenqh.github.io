<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>üì∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Materialize CSS -->
  <link href="https://cdn.bootcdn.net/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    body {
      font-weight: bold;
    }
    a {
      color: black !important;
    }
  </style>
</head>
<body>
  <!-- Áî®Êà∑ËæìÂÖ• TvBox URL Âíå Ë°®ÂçïÊèê‰∫§ -->
  <div class="container" style="padding-top: 20px;">
    <form id="tvboxForm" method="POST">
      <div class="input-field col s12">
        <input id="tvbox-url" type="text" placeholder="TvBox URL" class="validate">
        <label for="tvbox-url">TvBox URL</label>
      </div>
      <!-- ÈöêËóèÂ≠óÊÆµÁî®‰∫éÈ¢ëÈÅìÊèê‰∫§ -->
      <input id="formUrl" type="hidden" name="url">
      <input id="formAction" type="hidden" name="do" value="push">
    </form>
  </div>

  <div class="container">
    <h5 class="center-align">Áõ¥Êí≠ÂàóË°®</h5>
    <div class="row">
      <div class="col s12">
        <ul class="tabs" id="tabHeader"></ul>
      </div>
      <div id="tabContent" class="col s12"></div>
    </div>
  </div>

  <!-- Materialize JS -->
  <script src="https://cdn.bootcdn.net/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    const SOURCE_URL = '/tv.txt'; // Êú¨Âú∞Êñá‰ª∂Ë∑ØÂæÑ

    // ÂºÇÊ≠•Âä†ËΩΩÊñáÊú¨ÂÜÖÂÆπ
    const fetchText = async (url) => {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Âä†ËΩΩÂ§±Ë¥•');
      return res.text();
    };

    // Ëß£ÊûêÁõ¥Êí≠Ê∫êÊ†ºÂºè
    const parseSource = (text) => {
      const lines = text.trim().split(/\r?\n/);
      const result = [];
      let currentCategory = null;

      for (const line of lines) {
        if (line.endsWith(',#genre#')) {
          const title = line.split(',')[0].trim();
          currentCategory = { title, items: [] };
          result.push(currentCategory);
        } else if (currentCategory && line.includes(',')) {
          const [name, url] = line.split(',');
          currentCategory.items.push({ name: name.trim(), url: url.trim() });
        }
      }

      return result;
    };

    // Ê∏≤ÊüìÂàÜÁ±ªÂíåÈ¢ëÈÅìÈ°π
    const render = (data) => {
      const tabHeader = document.getElementById('tabHeader');
      const tabContent = document.getElementById('tabContent');
      tabHeader.innerHTML = '';
      tabContent.innerHTML = '';

      data.forEach((cat, i) => {
        const id = `tab-${i}`;
        tabHeader.innerHTML += `
          <li class="tab col s3">
            <a href="#${id}" class="${i === 0 ? 'active' : ''}">${cat.title}</a>
          </li>
        `;

        const listItems = cat.items.map(({ name, url }) =>
          `<li class="collection-item">
            <a href="#!" onclick="submitForm('${url}')">
              ${name}<div class="grey-text text-darken-1" style="font-size: 12px; margin-top: 4px;">${url}</div>
            </a>
          </li>`
        ).join('');

        tabContent.innerHTML += `
          <div id="${id}" class="col s12">
            <ul class="collection">${listItems}</ul>
          </div>
        `;
      });

      M.Tabs.init(tabHeader);
    };

    // Êèê‰∫§È¢ëÈÅìÂú∞ÂùÄÂà∞ÁõÆÊ†áÊé•Âè£
    const submitForm = (channelUrl) => {
      const baseUrl = document.getElementById('tvbox-url').value.trim();

      localStorage.setItem('tvbox-url', baseUrl);

      const form = document.getElementById('tvboxForm');
      form.action = `${baseUrl}/action`;

      document.getElementById('formUrl').value = channelUrl;
      form.submit();
    };

    // È°µÈù¢Âä†ËΩΩÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', async () => {
      const tvboxInput = document.getElementById('tvbox-url');
      const savedUrl = localStorage.getItem('tvbox-url');
      tvboxInput.value = savedUrl || 'http://192.168.1.6:9978';

      try {
        const raw = await fetchText(SOURCE_URL);
        const parsed = parseSource(raw);
        render(parsed);
      } catch (err) {
        alert('Áõ¥Êí≠Ê∫êÂä†ËΩΩÂ§±Ë¥•Ôºö' + err.message);
      }
    });
  </script>
</body>
</html>
