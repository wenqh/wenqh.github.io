<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“º</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Materialize CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>
        body {
            font-weight: bold;
        }
        a {
            color: black !important;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            height: auto;
        }
        .tabs a.active {
            background-color: #555 !important;
            color: white !important;
        }
        .scroll-container {
            min-height: 100vh;
            height: 100vh;
            overflow-y: scroll;
        }
        .collection-item a {
            display: block;
        }
    </style>
</head>
<body>
<div class="container" style="padding-top: 20px;">
    <button class="modal-trigger" href="#modal1">è®¾ç½®URL</button>
    <span class="switch"><label>ç¼–è¾‘<input type="checkbox" id="edit"><span class="lever"></span></label></span>
    <button id="export">å¯¼å‡º</button>
    <a id="tvbox-url-link" target="_blank">OKå½±è§†</a>
    <a href="tv-epg.html" target="_blank">èŠ‚ç›®è¡¨</a>

    <!-- Modal Structure -->
    <div id="modal1" class="modal">
        <div class="modal-content">
            <h4>TVBox URL</h4>
            <input id="tvbox-url-input" type="text" placeholder="TvBox URL" class="validate">
        </div>
        <div class="modal-footer">
            <a id="tvbox-url-save" href="#!" class="modal-close btn-flat">ç¡®å®š</a>
        </div>
    </div>
</div>

<div class="container">
    <!-- <h5 class="center-align">ç›´æ’­åˆ—è¡¨</h5> -->
    <div class="row">
        <div class="col s3 scroll-container">
            <ul class="tabs" id="tabHeader"></ul>
        </div>
        <div id="tabContent" class="col s9">åŠ è½½ä¸­...</div>
    </div>
    <!--<div class="row">
        <div class="col s12">
            <ul class="tabs" id="tabHeader"></ul>
        </div>
        <div id="tabContent" class="col s12">åŠ è½½ä¸­...</div>
    </div>-->
</div>

<!-- Materialize JS -->
<script src="https://cdn.bootcdn.net/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    const SOURCE_URL = 'tv.txt'; // æœ¬åœ°æ–‡ä»¶è·¯å¾„
    let tvBoxUrl = 'http://192.168.1.2:9978';

    // å¼‚æ­¥åŠ è½½æ–‡æœ¬å†…å®¹
    const fetchText = async (url) => {
        const res = await fetch(url);
        if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
        return res.text();
    };

    // è§£æç›´æ’­æºæ ¼å¼
    const parseSource = (text) => {
        const lines = text.trim().split(/\r?\n/);
        const result = [];
        let currentCategory = null;
        let idx = 0;

        for (const line of lines) {
            if (line.endsWith(',#genre#')) {
                const title = line.split(',')[0].trim();
                currentCategory = { title, items: [] };
                result.push(currentCategory);
            } else if (currentCategory && line.includes(',')) {
                const [name, url] = line.split(',');

                // æŸ¥æ‰¾å½“å‰åˆ†ç±»ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥é¢‘é“å
                const existing = currentCategory.items.find(item => item.name === name);
                const idx_ = existing ? existing.idx : ++idx;

                currentCategory.items.push({idx: idx_, name: name.trim(), url: url.trim() });
            }
        }

        return result;
    };

    // æ¸²æŸ“åˆ†ç±»å’Œé¢‘é“é¡¹
    const render = (data) => {
        const tabHeader = document.getElementById('tabHeader');
        const tabContent = document.getElementById('tabContent');
        tabHeader.innerHTML = '';
        tabContent.innerHTML = '';

        data.forEach((cat, i) => {
            const id = `tab-${i}`;
            tabHeader.innerHTML += `
          <li class="tab">
            <a href="#${id}" class="${i === 0 ? 'active' : ''}">${cat.title}</a>
          </li>
        `;

            const listItems = cat.items.map(({idx, name, url}) =>
                `<li class="collection-item">
            <a href="${url}" onclick="play('${url}', event)"
                oncontextmenu="edit(event)">
              ${idx} ${name}
              <div style="color: #888">${url}</div>
            </a>
          </li>`
            ).join('');

            tabContent.innerHTML += `
          <div id="${id}" class="scroll-container">
            <ul class="collection">${listItems}</ul>
          </div>
        `;
        });

        M.Tabs.init(tabHeader);
    };

    // æäº¤é¢‘é“åœ°å€åˆ°ç›®æ ‡æ¥å£
    const play = (channelUrl, event) => {
        event.preventDefault();
        /*if (document.querySelector('#edit').checked) {
            return;
        }*/
        window.open(`${tvBoxUrl}/action?do=push&url=${encodeURIComponent(channelUrl)}`, '_blank');
    };


    // é¡µé¢åŠ è½½åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
        tvBoxUrl = localStorage.getItem('tvbox-url') || tvBoxUrl;

        M.Modal.init(document.querySelectorAll('.modal'));

        var tvBoxUrlInput = document.getElementById('tvbox-url-input');
        tvBoxUrlInput.value = tvBoxUrl;
        document.getElementById('tvbox-url-link').href = tvBoxUrl;
        document.getElementById('tvbox-url-save').addEventListener('click', () => {
            tvBoxUrl = tvBoxUrlInput.value.trim();
            localStorage.setItem('tvbox-url', tvBoxUrl);
        })

        try {
            const raw = await fetchText(SOURCE_URL);
            const parsed = parseSource(raw);
            render(parsed);
        } catch (err) {
            alert('ç›´æ’­æºåŠ è½½å¤±è´¥ï¼š' + err.message);
        }
    });


    document.addEventListener('oncontextmenu', (e)=> {
        e.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
        const div = e.target;
        div.setAttribute('contenteditable', 'true');
        div.focus();
        
        // å¤±å»ç„¦ç‚¹é€€å‡ºç¼–è¾‘æ¨¡å¼
        div.addEventListener('blur', () => {
            div.removeAttribute('contenteditable');
        }, { once: true });
    });
    /*document.querySelector('#edit').addEventListener('change', function() {
        document.querySelector("#tabContent").setAttribute('contenteditable', this.checked)
        document.querySelector("#tabHeader").setAttribute('contenteditable', this.checked)
    });*/


    document.querySelector('#export').addEventListener('click', () => {
        let raw = '';

        const tabs = document.querySelectorAll("ul.tabs li");
        document.querySelectorAll("ul.collection").forEach((ul, i) => {
            const catTitle = tabs[i].textContent.trim();
            raw += '\n' + catTitle + ',#genre#\n';

            for (const li of ul.querySelectorAll("li.collection-item")) {
                const link = li.querySelector('a');

                const name = link?.childNodes[0]?.nodeValue?.trim()?.replace(/^\d+\s+/, '')
                const url = link?.href

                raw += `${name},${url}\n`;
            }
        });

        // 5. åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶ï¼ˆè¿™éƒ¨åˆ†å’Œä¹‹å‰ä¸€æ ·ï¼‰
        if (!raw) {
            return;
        }
        const blob = new Blob([raw], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');

        link.href = URL.createObjectURL(blob);
        link.download = SOURCE_URL;

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
</script>
</body>
</html>
